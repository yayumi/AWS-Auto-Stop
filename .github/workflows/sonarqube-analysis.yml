# Quality Gate ìƒíƒœ í™•ì¸ ë° PRì— ê²°ê³¼ í‘œì‹œ
- name: Check Quality Gate and Issues
    id: sonarqube-check
    run: |
      # API ì‘ë‹µ ëŒ€ê¸° ì‹œê°„ ì¦ê°€
      sleep 10
      
      # ê²°ê³¼ íŒŒì¼ ìƒì„±
      echo "### SonarQube Analysis Results" > sonar-report.md
      echo "" >> sonar-report.md
      
      # Quality Gate ìƒíƒœ í™•ì¸ ë° ì¶œë ¥
      QUALITY_GATE_RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" "${{ secrets.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=yayumi_AWS-Auto-Stop_158bc810-b369-4089-be0b-d9c6b7209894")
      
      # API ì‘ë‹µ ë””ë²„ê¹… - ìˆ˜ì •ëœ ë¶€ë¶„
      echo "Debug - Quality Gate Response:"
      echo "${QUALITY_GATE_RESPONSE}"
      
      # ì‘ë‹µ ê²€ì¦
      if [ -z "${QUALITY_GATE_RESPONSE}" ]; then
        echo "#### Quality Gate Status: âš ï¸ No response from SonarQube" >> sonar-report.md
      else
        # JSON ìœ íš¨ì„± ê²€ì‚¬
        if echo "${QUALITY_GATE_RESPONSE}" | jq empty 2>/dev/null; then
          # Quality Gate ìƒíƒœ íŒŒì‹±
          STATUS=$(echo "${QUALITY_GATE_RESPONSE}" | jq -r '.projectStatus.status // "UNKNOWN"')
          
          # ìƒíƒœì— ë”°ë¥¸ ì¶œë ¥
          if [ "$STATUS" = "OK" ]; then
            echo "#### Quality Gate Status: âœ… PASSED" >> sonar-report.md
          elif [ "$STATUS" = "ERROR" ]; then
            echo "#### Quality Gate Status: âŒ FAILED" >> sonar-report.md
          else
            echo "#### Quality Gate Status: âš ï¸ UNKNOWN" >> sonar-report.md
          fi
        else
          echo "#### Quality Gate Status: âš ï¸ Invalid response format" >> sonar-report.md
          echo "Raw response: ${QUALITY_GATE_RESPONSE}" >> sonar-report.md
        fi
      fi
      echo "" >> sonar-report.md
      
      # ë©”íŠ¸ë¦­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      echo "#### Quality Metrics" >> sonar-report.md
      echo "Getting metrics data..."
      METRICS_RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" "${{ secrets.SONAR_HOST_URL }}/api/measures/component?component=yayumi_AWS-Auto-Stop_158bc810-b369-4089-be0b-d9c6b7209894&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,security_hotspots,reliability_rating,security_rating,sqale_rating")
      
      if [ -n "${METRICS_RESPONSE}" ] && echo "${METRICS_RESPONSE}" | jq empty 2>/dev/null; then
        echo "| Metric | Value | Rating |" >> sonar-report.md
        echo "|--------|-------|---------|" >> sonar-report.md
        
        # ë©”íŠ¸ë¦­ íŒŒì‹± ë° ì¶œë ¥
        echo "${METRICS_RESPONSE}" | jq -r '.component.measures[] | select(.value != null) | "| \(.metric) | \(.value) | \(
          if .metric == "reliability_rating" or 
              .metric == "security_rating" or 
              .metric == "sqale_rating" 
          then
            if .value == "1.0" then "A"
            elif .value == "2.0" then "B"
            elif .value == "3.0" then "C"
            elif .value == "4.0" then "D"
            elif .value == "5.0" then "E"
            else "-"
            end
          else "-"
          end
        ) |"' >> sonar-report.md
      else
        echo "Failed to get metrics data" >> sonar-report.md
      fi
      
      echo "" >> sonar-report.md
      
      # ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      echo "#### Issues" >> sonar-report.md
      echo "" >> sonar-report.md
      
      for SEVERITY in "BLOCKER" "CRITICAL" "MAJOR"; do
        echo "Getting ${SEVERITY} issues..."
        ISSUES_RESPONSE=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" "${{ secrets.SONAR_HOST_URL }}/api/issues/search?componentKeys=yayumi_AWS-Auto-Stop_158bc810-b369-4089-be0b-d9c6b7209894&severities=${SEVERITY}&resolved=false")
        
        if [ -n "${ISSUES_RESPONSE}" ] && echo "${ISSUES_RESPONSE}" | jq empty 2>/dev/null; then
          TOTAL=$(echo "${ISSUES_RESPONSE}" | jq -r '.total')
          
          if [ "${TOTAL}" != "0" ]; then
            case "${SEVERITY}" in
              "BLOCKER") ICON="ğŸš«";;
              "CRITICAL") ICON="â—";;
              "MAJOR") ICON="âš ï¸";;
            esac
            
            echo "${ICON} **${SEVERITY} Issues** (${TOTAL})" >> sonar-report.md
            echo "| Rule | Message | File |" >> sonar-report.md
            echo "|------|---------|------|" >> sonar-report.md
            
            echo "${ISSUES_RESPONSE}" | jq -r '.issues[] | "| \(.rule) | \(.message) | \(.component) |"' >> sonar-report.md
            echo "" >> sonar-report.md
          fi
        else
          echo "Failed to get ${SEVERITY} issues data" >> sonar-report.md
        fi
      done
      
      echo "---" >> sonar-report.md
      echo "ğŸ” [View detailed report](${{ secrets.SONAR_HOST_URL }}/dashboard?id=yayumi_AWS-Auto-Stop_158bc810-b369-4089-be0b-d9c6b7209894)" >> sonar-report.md
      
      # GitHub í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥
      echo "comment<<EOF" >> $GITHUB_ENV
      cat sonar-report.md >> $GITHUB_ENV
      echo "EOF" >> $GITHUB_ENV
      
      # ë””ë²„ê·¸ ì¶œë ¥
      echo "Final report content:"
      cat sonar-report.md
    continue-on-error: true

# PRì— ê²°ê³¼ ì½”ë©˜íŠ¸ ì¶”ê°€
- name: Add PR Comment
  if: github.event_name == 'pull_request'
  uses: marocchino/sticky-pull-request-comment@v2
  with:
    message: ${{ env.comment }}
    header: sonarqube-report